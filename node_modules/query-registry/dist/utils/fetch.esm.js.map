{"version":3,"file":"fetch.esm.js","sources":["../../src/utils/fetch.ts"],"sourcesContent":["import unfetch from 'isomorphic-unfetch';\nimport lru from 'tiny-lru';\nimport { FetchError } from './errors';\nimport { log } from './log';\n\nconst maxItems = 250;\nconst fiveMinutesTTL = 5 * 60 * 1000;\nconst cache = lru(maxItems, fiveMinutesTTL);\n\nexport async function fetch({\n    url,\n    headers,\n    cached = true,\n}: {\n    url: string;\n    headers?: Record<string, string>;\n    cached?: boolean;\n}): Promise<any> {\n    const cacheKey = `headers=${JSON.stringify(headers)};url=${url}`;\n    const cachedJSON = cache.get(cacheKey);\n    if (cached && cachedJSON) {\n        log('fetch: returning cached response: %O', {\n            cacheKey,\n            url,\n            cachedJSON,\n        });\n        return cachedJSON;\n    }\n\n    const response = await unfetch(url, { headers });\n    if (!response.ok) {\n        log('fetch: request failed: %O', {\n            url,\n            headers,\n            status: response.statusText,\n            response,\n        });\n        throw new FetchError(url, response);\n    }\n\n    const json = await response.json();\n    if (cached) {\n        cache.set(cacheKey, json);\n    }\n\n    log('fetch: returning fresh response: %O', { url, json });\n    return json;\n}\n"],"names":["maxItems","fiveMinutesTTL","cache","lru","fetch","url","headers","cached","cacheKey","JSON","stringify","cachedJSON","get","log","response","unfetch","ok","status","statusText","FetchError","json","set"],"mappings":";;;;;AAKA,MAAMA,QAAQ,GAAG,GAAjB,CAAA;AACA,MAAMC,cAAc,GAAG,CAAI,GAAA,EAAJ,GAAS,IAAhC,CAAA;AACA,MAAMC,KAAK,gBAAGC,GAAG,CAACH,QAAD,EAAWC,cAAX,CAAjB,CAAA;AAEO,eAAeG,KAAf,CAAqB;EACxBC,GADwB;EAExBC,OAFwB;AAGxBC,EAAAA,MAAM,GAAG,IAAA;AAHe,CAArB,EAQN;EACG,MAAMC,QAAQ,GAAc,CAAA,QAAA,EAAAC,IAAI,CAACC,SAAL,CAAeJ,OAAf,CAAuB,CAAQD,KAAAA,EAAAA,GAAG,CAA9D,CAAA,CAAA;AACA,EAAA,MAAMM,UAAU,GAAGT,KAAK,CAACU,GAAN,CAAUJ,QAAV,CAAnB,CAAA;;EACA,IAAID,MAAM,IAAII,UAAd,EAA0B;IACtBE,GAAG,CAAC,sCAAD,EAAyC;MACxCL,QADwC;MAExCH,GAFwC;AAGxCM,MAAAA,UAAAA;AAHwC,KAAzC,CAAH,CAAA;AAKA,IAAA,OAAOA,UAAP,CAAA;AACH,GAAA;;AAED,EAAA,MAAMG,QAAQ,GAAG,MAAMC,OAAO,CAACV,GAAD,EAAM;AAAEC,IAAAA,OAAAA;AAAF,GAAN,CAA9B,CAAA;;AACA,EAAA,IAAI,CAACQ,QAAQ,CAACE,EAAd,EAAkB;IACdH,GAAG,CAAC,2BAAD,EAA8B;MAC7BR,GAD6B;MAE7BC,OAF6B;MAG7BW,MAAM,EAAEH,QAAQ,CAACI,UAHY;AAI7BJ,MAAAA,QAAAA;AAJ6B,KAA9B,CAAH,CAAA;AAMA,IAAA,MAAM,IAAIK,UAAJ,CAAed,GAAf,EAAoBS,QAApB,CAAN,CAAA;AACH,GAAA;;AAED,EAAA,MAAMM,IAAI,GAAG,MAAMN,QAAQ,CAACM,IAAT,EAAnB,CAAA;;AACA,EAAA,IAAIb,MAAJ,EAAY;AACRL,IAAAA,KAAK,CAACmB,GAAN,CAAUb,QAAV,EAAoBY,IAApB,CAAA,CAAA;AACH,GAAA;;EAEDP,GAAG,CAAC,qCAAD,EAAwC;IAAER,GAAF;AAAOe,IAAAA,IAAAA;AAAP,GAAxC,CAAH,CAAA;AACA,EAAA,OAAOA,IAAP,CAAA;AACH;;;;"}